- [Информация](#информация)
- [Поток данных](#поток-данных)
- [Подписка](#подписка)
- [Примеры подписки](#примеры-подписки)
- [Пример ответа при удачной авторизации](#пример-ответа-при-удачной-авторизации)
- [Пример ответа при удачной подписки](#пример-ответа-при-удачной-подписки)
- [Пример получаемых данных](#пример-получаемых-данных)
- [Параметры получаемых данных](#параметры-получаемых-данных)

<a id="информация"></a>

Подписка на ленту ордеров, чтобы видеть изменения в ваших ордерах в режиме реального времени.

>Информация:
>
>- Поток данных `order` и потоки данных `order.spot`, `order.linear`, `order.inverse`,
> `order.option` не могут находиться в одном запросе на подписку.
>- Поток данных `order` позволяет прослушивать обновления WebSocket всех категорий
> (`spot`, `linear` `inverse` `option`).
>- Потоки данных `order.spot`, `order.linear`, `order.inverse`, `order.option` позволяют прослушивать
> обновления WebSocket только определённой категории.

Совет:

Вы можете получить два сообщения `orderStatus`=`Filled`, если запрос на отмену принят, но сам заказ выполнен.
Как правило, одно сообщение содержит `orderStatus`=`Filled`, `rejectReason`=`EC_NoError`, а другое — `orderStatus`=`Filled`, `cancelType`=`CancelByUser`, `rejectReason`=`EC_OrigClOrdIDDoesNotExist`. Первое сообщение сообщает о выполнении заказа, а второе — о том, что последующий запрос на отмену отклонен, поскольку заказ выполнен.

<a id="поток-данных"></a>

## Поток данных

`order`
`order.spot`
`order.linear`
`order.inverse`
`order.option`

<a id="подписка"></a>

## Подписка

```json
{
    "op": "subscribe",
    "args": [
        "order"
    ]
}
```

<a id="примеры-подписки"></a>

## Примеры подписки

- собственная реализация

  ```python
  import hmac
  import json
  import time
  import websocket
  
  url = "wss://stream-testnet.bybit.com/v5/private"
  api_key = "<api_key от биржи bybit>"
  api_secret = "<api_secret от биржи bybit>"
  
  def on_message(ws, message):
      try:
          data = json.loads(message)
          print(f"Полученное сообщение: {message}")
      except json.JSONDecodeError:
          print(f"Не удалось распарсить сообщение: {message}")
          return
  
      if data.get("op") == "auth" and data.get("success") is True:
          print("Аутентификация успешна. Отправляю подписку на 'position'")
          subscribe_request = {
              "op": "subscribe",
              "args": [
                  "order.linear"
              ]
          }
          ws.send(json.dumps(subscribe_request))
  
  def on_error(ws, error):
      print(f"Ошибка: {error}")
  
  def on_close(ws, close_status_code, close_msg):
      print(f"Соединение закрыто: {close_status_code} {close_msg}")
  
  def on_open(ws):
      print("Соединение открыто")
  
      expires = int((time.time() + 1) * 1000)
      signature = str(hmac.new(
          key=api_secret.encode("utf-8"),
          msg=f"GET/realtime{expires}".encode("utf-8"),
          digestmod="sha256"
      ).hexdigest())
  
      auth_request = {
          "op": "auth",
          "args": [
              api_key,
              expires,
              signature
          ]
      }
      ws.send(json.dumps(auth_request))

      print("Запрос аутентификации отправлен")
  
  def run_websocket():
      while True:
          ws = websocket.WebSocketApp(url)
          ws.on_message = on_message
          ws.on_error = on_error
          ws.on_close = on_close
          ws.on_open = on_open
  
          ws.run_forever(
              ping_interval=20,
              ping_timeout=5
          )
  
          print("Соединение потеряно. Попытка переподключения...")
          time.sleep(5)
  
  run_websocket()
  ```

- pybit

  ```python
  from time import sleep

  from pybit.unified_trading import WebSocket

  ws = WebSocket(
      testnet=True,
      channel_type="private",
      api_key="<api_key от биржи bybit>",
      api_secret="<api_secret от биржи bybit>",
  )

  def handle_message(message):
      print(message)

  ws.order_stream(
    callback=handle_message
  )

  while True:
      sleep(1)
  ```

<a id="пример-ответа-при-удачной-авторизации"></a>

## Пример ответа при удачной авторизации

```json
{
    "success": true,
    "ret_msg": "",
    "op": "auth",
    "conn_id": "d266o6hqo29sqmnq4vk0-7ga4j"
}
```

<a id="пример-ответа-при-удачной-подписки"></a>

## Пример ответа при удачной подписки

```json
{
    "success": true,
    "ret_msg": "",
    "op": "subscribe",
    "conn_id": "d266oeddaugoadim24og-761j0"
}
```

<a id="пример-получаемых-данных"></a>

## Пример получаемых данных

```json
{
    "id": "5923240c6880ab-c59f-420b-9adb-3639adc9dd90",
    "topic": "order",
    "creationTime": 1672364262474,
    "data": [
        {
            "symbol": "ETH-30DEC22-1400-C",
            "orderId": "5cf98598-39a7-459e-97bf-76ca765ee020",
            "side": "Sell",
            "orderType": "Market",
            "cancelType": "UNKNOWN",
            "price": "72.5",
            "qty": "1",
            "orderIv": "",
            "timeInForce": "IOC",
            "orderStatus": "Filled",
            "orderLinkId": "",
            "lastPriceOnCreated": "",
            "reduceOnly": false,
            "leavesQty": "",
            "leavesValue": "",
            "cumExecQty": "1",
            "cumExecValue": "75",
            "avgPrice": "75",
            "blockTradeId": "",
            "positionIdx": 0,
            "cumExecFee": "0.358635",
            "closedPnl": "0",
            "createdTime": "1672364262444",
            "updatedTime": "1672364262457",
            "rejectReason": "EC_NoError",
            "stopOrderType": "",
            "tpslMode": "",
            "triggerPrice": "",
            "takeProfit": "",
            "stopLoss": "",
            "tpTriggerBy": "",
            "slTriggerBy": "",
            "tpLimitPrice": "",
            "slLimitPrice": "",
            "triggerDirection": 0,
            "triggerBy": "",
            "closeOnTrigger": false,
            "category": "option",
            "placeType": "price",
            "smpType": "None",
            "smpGroup": 0,
            "smpOrderId": "",
            "feeCurrency": "",
            "cumFeeDetail": {
                "MNT": "0.00242968"
            }
        }
    ]
}
```

<a id="параметры-получаемых-данных"></a>

## Параметры получаемых данных

|Параметр  |Тип       |Комментарии                                             |
|----------|----------|--------------------------------------------------------|
|id        |string    |Идентификатор сообщения                                             |
|topic     |string    |Название потока данных                                             |
|creationTime | number | Временная метка создания данных (в миллисекундах) |
|data | array | Массив объектов. |
|category | string | Тип продукта<br><br>- [UTA2.0](<../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-2.0>), [UTA1.0](<../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>): `spot`, `linear`, `inverse`, `option`<br>- Классический аккаунт: `spot`, `linear`, `inverse`. |
|symbol | string | Название символа |
|side | string | Сторона. `Buy`,`Sell` |
|orderId | string | Идентификатор ордера |
|orderLinkId | string | Пользовательский идентификатор ордера |
|isLeverage | string | Будет ли заем.<br><br>- Единый аккаунт: только`spot`. `0`: false, `1`: true<br>- Классический аккаунт `spot` не поддерживается, всегда `0` |
|blockTradeId | string | Идентификатор блока торговли |
|price | string | Цена ордера |
|brokerOrderPrice | string | Специализированное поле для ликвидности-провайдера EU |
|qty | string | Количество ордера |
|[positionIdx](<../../19.Определения значений в запросах и ответах.md#positionIdx>) | integer | Индекс позиции. Используется для идентификации позиций в разных режимах позиций |
|[orderStatus](<../../19.Определения значений в запросах и ответах.md#orderStatus>) | string | Статус ордера |
|[createType](<../../19.Определения значений в запросах и ответах.md#createType>) | string | Тип создания ордера<br><br>- Только для `category`=`linear` или `inverse`<br>- `spot`, `option` не имеют этого ключа |
|[cancelType](<../../19.Определения значений в запросах и ответах.md#cancelType>) | string | Тип отмены |
|[rejectReason](<../../19.Определения значений в запросах и ответах.md#rejectReason>) | string | Причина отклонения. Классический аккаунт `spot` не поддерживается |
|avgPrice | string | Средняя цена исполнения<br><br>- Возвращает `""` для ордеров без средней цены, и также для ордеров классического аккаунта, которые были частично исполнены, но отменены в конце<br>- Классический аккаунт `spot` не поддерживается, всегда `""` |
|leavesQty | string | Оставшееся не исполненное количество. Классический аккаунт `spot` не поддерживается |
|leavesValue | string | Оставшееся не исполненное значение. Классический аккаунт `spot` не поддерживается |
|cumExecQty | string | Общее количество исполненного ордера |
|cumExecValue | string | Общая стоимость исполненного ордера |
|cumExecFee | string | - `inverse`, `option`: Кумулятивная исполненная торговая комиссия.<br>- `linear`, `spot`: **Устарело**. Используйте `cumFeeDetail`.<br>- Классический аккаунт `spot`: это последняя комиссия исполнения для ордера.<br>- После обновления до объединенного аккаунта, вы можете использовать `execFee` для каждого fill в теме [Подключить трансляцию об исполнении ордеров](<Подключить трансляцию об исполнении ордеров.md>)  |
|closedPnl | string | Закрытая прибыль и убыток для каждого ордера закрытия позиции. Цифра такая же, как `closedPnl` из [Получить закрытый PnL](<../../Position/Получить закрытый PnL.md>) |
|feeCurrency | string | **Устарело**. Валюта торговой комиссии только для Spot. Пожалуйста, ознакомьтесь с валютой комиссии за спотовую торговлю [здесь](<../../19.Определения значений в запросах и ответах.md#Spot Fee Currency Instruction>) |
|[timeInForce](<../../19.Определения значений в запросах и ответах.md#timeInForce>) | string | Время действия |
|[orderType](<../../19.Определения значений в запросах и ответах.md#orderType>) | string | Тип ордера. `Market`,`Limit`.<br><br>- Для TP/SL ордеров, это тип ордера после того, как ордер был активирован |
|[stopOrderType](<../../19.Определения значений в запросах и ответах.md#stopOrderType>) | string | Тип стоп-ордера |
|ocoTriggerBy | string | Тип триггера Spot OCO ордера.`OcoTriggerByUnknown`, `OcoTriggerByTp`, `OcoTriggerBySl`. Классический аккаунт `spot` не поддерживается |
|orderIv | string | Предполагаемая  волатильность |
|marketUnit | string | Единица `qty` при создании `spot` market orders для единого аккаунта. `baseCoin`, `quoteCoin` |
|slippageToleranceType | string | Тип допуска проскальзывания на `spot` и `futures` рынке. `TickSize`, `Percent`, `UNKNOWN`(по умолчанию) |
|slippageTolerance | string | Значение допуска проскальзывания |
|triggerPrice | string | Цена триггера.<br>Если `stopOrderType`=`TrailingStop`, это активирующая цена. Иначе — цена триггера |
|takeProfit | string | Цена тейк-профита |
|stopLoss | string | Цена стоп-лосса |
|tpslMode | string | Режим тейк-профит/стоп-лосс:<br>`Full` — весь объём позиции для тейк-профита/стоп-лосса;<br>`Partial` — частичный объём позиции<br>`spot` не поддерживается<br>`option` всегда возвращает "" |
|tpLimitPrice | string | Цена лимитного ордера при срабатывании цены тейк-профита |
|slLimitPrice | string | Цена лимитного ордера при срабатывании цены стоп-лосса |
|[tpTriggerBy](<../../19.Определения значений в запросах и ответах.md#triggerBy>) | string | Тип цены для срабатывания тейк-профита |
|[slTriggerBy](<../../19.Определения значений в запросах и ответах.md#triggerBy>) | string | Тип цены для срабатывания стоп-лосса |
|triggerDirection | integer | Направление триггера. `1`: рост, `2`: падение |
|[triggerBy](<../../19.Определения значений в запросах и ответах.md#triggerBy>) | string | Тип цены триггера |
|lastPriceOnCreated | string | Последняя цена при размещении ордера |
|reduceOnly | boolean | Только уменьшение. `true` означает уменьшение размера позиции |
|closeOnTrigger | boolean | Закрыть при триггере. [Что такое ордер закрытия при триггере?](https://www.bybit.com/en/help-center/article/Close-On-Trigger-Order) |
|placeType | string | Тип размещения, используется для `option`: `iv`, `price`|
|[smpType](<../../19.Определения значений в запросах и ответах.md#smpType>) | string | Тип исполнения SMP |
|smpGroup | integer | Идентификатор группы Smp. Если UID не имеет группы, по умолчанию `0` |
|smpOrderId | string | orderID контрагента, который вызывает это SMP исполнение |
|createdTime | string | Временная метка создания ордера (в миллисекундах) |
|updatedTime | string | Временная метка обновления ордера (в миллисекундах) |
|cumFeeDetail | json | `linear`, `spot`: Детали кумулятивной торговой комиссии вместо `cumExecFee` |
