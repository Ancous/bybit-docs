- [Информация](#информация)
- [Поток данных](#поток-данных)
- [Подписка](#подписка)
- [Примеры подписки](#примеры-подписки)
- [Пример ответа при удачной авторизации](#пример-ответа-при-удачной-авторизации)
- [Пример ответа при удачной подписки](#пример-ответа-при-удачной-подписки)
- [Пример получаемых данных](#пример-получаемых-данных)
- [Параметры получаемых данных](#параметры-получаемых-данных)

<a id="информация"></a>

Подписка на ленту данных позиций, чтобы наблюдать за изменениями ваших позиций в режиме реального времени.

>Информация:
>
>- Поток данных `position` и потоки данных `position.linear`, `position.inverse`, `position.option` не могут находиться
> в одном запросе на подписку.
>- Поток данных `position` позволяет прослушивать обновления WebSocket всех категорий (`linear` `inverse` `option`).
>- Потоки данных `position.linear`, `position.inverse`, `position.option` позволяют прослушивать обновления WebSocket
> только определённой категории.
<!-- -->
>Совет:
>
>Каждый раз, когда вы создаете/изменяете/отменяете ордер, в потоке данных о позиции будет генерироваться новое
>сообщение (независимо от того, произошли ли какие-либо фактические изменения).

<a id="поток-данных"></a>

## Поток данных

`position`  
`position.linear`  
`position.inverse`  
`position.option`

<a id="подписка"></a>

## Подписка

```json
{
    "op": "subscribe",
    "args": [
        "position"
    ]
}
```

<a id="примеры-подписки"></a>

## Примеры подписки

- собственная реализация

  ```python
  import hmac
  import json
  import time
  import websocket
  
  url = "wss://stream-testnet.bybit.com/v5/private"
  api_key = "<api_key от биржи bybit>"
  api_secret = "<api_secret от биржи bybit>"
  
  def on_message(ws, message):
      try:
          data = json.loads(message)
          print(f"Полученное сообщение: {message}")
      except json.JSONDecodeError:
          print(f"Не удалось распарсить сообщение: {message}")
          return
  
      if data.get("op") == "auth" and data.get("success") is True:
          print("Аутентификация успешна. Отправляю подписку на 'position'")
          subscribe_request = {
              "op": "subscribe",
              "args": [
                  "position"
              ]
          }
          ws.send(json.dumps(subscribe_request))
  
  def on_error(ws, error):
      print(f"Ошибка: {error}")
  
  def on_close(ws, close_status_code, close_msg):
      print(f"Соединение закрыто: {close_status_code} {close_msg}")
  
  def on_open(ws):
      print("Соединение открыто")
  
      expires = int((time.time() + 1) * 1000)
      signature = str(hmac.new(
          key=api_secret.encode("utf-8"),
          msg=f"GET/realtime{expires}".encode("utf-8"),
          digestmod="sha256"
      ).hexdigest())
  
      auth_request = {
          "op": "auth",
          "args": [
              api_key,
              expires,
              signature
          ]
      }
      ws.send(json.dumps(auth_request))

      print("Запрос аутентификации отправлен")
  
  def run_websocket():
      while True:
          ws = websocket.WebSocketApp(url)
          ws.on_message = on_message
          ws.on_error = on_error
          ws.on_close = on_close
          ws.on_open = on_open
  
          ws.run_forever(
              ping_interval=20,
              ping_timeout=5
          )
  
          print("Соединение потеряно. Попытка переподключения...")
          time.sleep(5)
  
  run_websocket()
  ```

- pybit

  ```python
  from time import sleep

  from pybit.unified_trading import WebSocket

  ws = WebSocket(
      testnet=True,
      channel_type="private",
      api_key="<api_key от биржи bybit>",
      api_secret="<api_secret от биржи bybit>",
  )

  def handle_message(message):
      print(message)

  ws.position_stream(
    callback=handle_message
  )

  while True:
      sleep(1)
  ```

<a id="пример-ответа-при-удачной-авторизации"></a>

## Пример ответа при удачной авторизации

```json
{
    "success": true,
    "ret_msg": "",
    "op": "auth",
    "conn_id": "d266o6hqo29sqmnq4vk0-7ga4j"
}
```

<a id="пример-ответа-при-удачной-подписки"></a>

## Пример ответа при удачной подписки

```json
{
    "success": true,
    "ret_msg": "",
    "op": "subscribe",
    "conn_id": "d266oeddaugoadim24og-761j0"
}
```

<a id="пример-получаемых-данных"></a>

## Пример получаемых данных

```json
{
    "id": "1003076014fb7eedb-c7e6-45d6-a8c1-270f0169171a",
    "topic": "position",
    "creationTime": 1697682317044,
    "data": [
        {
            "positionIdx": 2,
            "tradeMode": 0,
            "riskId": 1,
            "riskLimitValue": "2000000",
            "symbol": "BTCUSDT",
            "side": "",
            "size": "0",
            "entryPrice": "0",
            "leverage": "10",
            "positionValue": "0",
            "positionBalance": "0",
            "markPrice": "28184.5",
            "positionIM": "0",
            "positionIMByMp": "0",
            "positionMM": "0",
            "positionMMByMp": "0",
            "takeProfit": "0",
            "stopLoss": "0",
            "trailingStop": "0",
            "unrealisedPnl": "0",
            "curRealisedPnl": "1.26",
            "cumRealisedPnl": "-25.06579337",
            "sessionAvgPrice": "0",
            "createdTime": "1694402496913",
            "updatedTime": "1697682317038",
            "tpslMode": "Full",
            "liqPrice": "0",
            "bustPrice": "",
            "category": "linear",
            "positionStatus": "Normal",
            "adlRankIndicator": 0,
            "autoAddMargin": 0,
            "leverageSysUpdatedTime": "",
            "mmrSysUpdatedTime": "",
            "seq": 8327597863,
            "isReduceOnly": false
        }
    ]
}
```

<a id="параметры-получаемых-данных"></a>

## Параметры получаемых данных

|Параметр  |Тип       |Комментарии                                             |
|----------|----------|--------------------------------------------------------|
|id        |string    |Идентификатор сообщения                                             |
|topic     |string    |Название потока данных                                             |
|creationTime | number | Временная метка создания данных (в миллисекундах) |
|data | array | Массив объектов. |
|category | string | Тип продукта |
|symbol | string | Название символа |
|side | string | Сторона позиции. `Buy`, `Sell`<br><br>- Односторонний режим: классический аккаунт и [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`inverse`), пустая позиция возвращает `None`.<br>- односторонний режим или режим хеджирования: [UTA2.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-2.0>)(`linear`, `inverse`) и [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`linear`): пустая позиция возвращает `""`. |
|size | string | Размер позиции |
|[positionIdx](</19.Определения значений в запросах и ответах.md#positionIdx>) | integer | Используется для идентификации позиций в разных режимах позиций |
|tradeMode | integer | Режим торговли<br><br>- Классический аккаунт и [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`inverse`): `0`: кросс-маржа, `1`: изолированная маржа<br>- [UTA2.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-2.0>), [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(кроме `inverse`): устарел, всегда `0`, проверьте [Получить информацию об аккаунте](</Account/Получить информацию об аккаунте.md>), чтобы узнать режим маржи |
|positionValue | string | Стоимость позиции |
|riskId | integer | Идентификатор уровня риска<br><br>Для режима портфельной маржи это поле возвращает `0`, что означает, что правила лимита риска недействительны |
|riskLimitValue | string | Значение лимита риска<br><br>Для режима портфельной маржи это поле возвращает `0`, что означает, что правила лимита риска недействительны |
|entryPrice | string | Цена входа |
|markPrice | string | Mark Price |
|leverage | string | Кредитное плечо позиции<br><br>Для режима портфельной маржи это поле возвращает `""`, что означает, что правила кредитного плеча недействительны |
|positionBalance | string | Маржа позиции<br><br>- Классический аккаунт и [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`inverse`) могут ссылаться на это поле для получения начальной маржи позиции |
|autoAddMargin | integer | Будет ли добавляться маржа автоматически.<br><br>`0`: false, `1`: true.<br>Для единого аккаунта значимо только когда единый аккаунт включает `ISOLATED_MARGIN` |
|positionIM | string | Начальная маржа<br><br>- Классический аккаунт и [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`inverse`): игнорируйте это поле<br>- Режим портфельной маржи единого аккаунта возвращает `""` |
|positionIMByMp | string | Начальная маржа, рассчитанная по Mark Price<br><br>- Классический аккаунт и [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`inverse`): игнорируйте это поле<br>* Режим портфельной маржи единого аккаунта возвращает `""` |
|positionMM | string | Маржа поддержки<br><br>- Классический аккаунт и [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`inverse`): игнорируйте это поле<br>- Режим портфельной маржи единого аккаунта возвращает `""` |
|positionMMByMp | string | Маржа поддержки, рассчитанная по Mark Price<br<br>- Классический аккаунт и [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`inverse`): игнорируйте это поле<br>- Режим портфельной маржи единого аккаунта возвращает `""` |
|liqPrice | string | Цена ликвидации позиции<br><br>- [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`inverse`), единый аккаунт(изолированная маржа включена) и Классический аккаунт: это реальная цена для изолированных и кросс-позиций, и сохраняет `""` когда `liqPrice` <= `minPrice` или `liqPrice` >= `maxPrice`<br>- Единый аккаунт(Режим кросс-маржи): это оценочная цена для кросс-позиций (потому что единый режим контролирует уровень риска по аккаунту), и сохраняет `""` когда `liqPrice` <= `minPrice` или `liqPrice` >= `maxPrice`<br>- Однако, это поле пустое для режима портфельной маржи, и цена ликвидации не будет предоставлена |
|bustPrice | string | Цена банкротства<br><br>- Единый режим возвращает `""`, без цены банкротства позиции (кроме [UTA1.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`inverse`)) |
|tpslMode | string | **Устарело.**, всегда `Full` |
|takeProfit | string | Цена тейк-профита |
|stopLoss | string | Цена стоп-лосса |
|trailingStop | string | Трейлинг-стоп |
|unrealisedPnl | string | Нереализованная прибыль и убыток |
|curRealisedPnl | string | Реализованный PnL для текущей удерживаемой позиции |
|sessionAvgPrice | string | Средняя цена сессии контракта USDC, это та же цифра, что и средняя цена входа, показанная в веб-интерфейсе |
|delta | string | Дельта. Передается только при подписке на позицию опциона. |
|gamma | string | Гамма. Передается только при подписке на позицию опциона. |
|vega | string | Вега. Передается только при подписке на позицию опциона. |
|theta | string | Тета. Передается только при подписке на позицию опциона. |
|cumRealisedPnl | string | Кумулятивный реализованный pnl<br><br>- `Perpetual` и `futures`: это кумулятивный реализованный P&L за все время<br>- `Option`: это реализованный P&L при удержании этой позиции |
|[positionStatus](</19.Определения значений в запросах и ответах.md#positionStatus>) | string | Статус позиции. `Normal`, `Liq`, `Adl` |
|[adlRankIndicator](</19.Определения значений в запросах и ответах.md#adlRankIndicator>) | integer | Индикатор Auto-deleverage. Что такое [Auto-deleverage](https://www.bybit.com/en-US/help-center/s/article/What-is-Auto-Deleveraging-ADL)? |
|isReduceOnly | boolean | Полезно, когда Bybit снижает лимит риска<br>- `true`: Разрешено только уменьшать позицию. Вы можете рассмотреть ряд мер, например, снизить лимит риска, уменьшить плечо или уменьшить позицию, добавить маржу или отменить ордера, после этих операций вы можете вызвать endpoint [Подтверждение нового risk limit](</Position/Подтверждение нового risk limit.md>), чтобы проверить, может ли быть снята метка `reduceOnly` с вашей позиции<br>- `false`: Нет ограничений, и это означает, что ваша позиция находится под риском, когда лимит риска корректируется систематически<br>- Значимо только для изолированной маржи и кросс-маржи `inverse` `linear`, бессмысленно для других |
|mmrSysUpdatedTime | string | Полезно, когда Bybit снижает лимит риска<br><br>- Когда `isReduceOnly`=`true`: временная метка (в миллисекундах), когда MMR будет принудительно скорректирован системой<br>- Когда `isReduceOnly`=`false`: временная метка, когда MMR был скорректирован системой<br>- Возвращает временную метку при работе системы, и если вы управляете вручную, временной метки нет<br>- По умолчанию сохраняет `""`, если ранее было системное понижение лимита риска, показывает ту временную метку системной операции<br>- Значимо только для изолированной маржи & кросс-маржи `inverse` `linear`, бессмысленно для других |
|leverageSysUpdatedTime | string | Полезно, когда Bybit снижает лимит риска<br><br>- Когда `isReduceOnly`=`true`: временная метка (в миллисекундах), когда плечо будет принудительно скорректировано системой<br>- Когда `isReduceOnly`=`false`: временная метка, когда плечо было скорректировано системой<br>- Возвращает временную метку при работе системы, и если вы управляете вручную, временной метки нет<br>- По умолчанию сохраняет `""`, если ранее было системное понижение лимита риска, показывает ту временную метку системной операции<br>* Значимо только для изолированной маржи & кросс-маржи `inverse` `linear`, бессмысленно для других |
|createdTime | string | Временная метка первого создания позиции на этом символе (в миллисекундах) |
|updatedTime | string | Временная метка обновления данных позиции (в миллисекундах) |
|seq | long | Кросс-последовательность, используется для ассоциации каждого fill и каждого обновления позиции<br><br>- Разные символы могут иметь одинаковый `seq`, пожалуйста, используйте `seq` + `symbol` для проверки уникальности<br>- Возвращает `"-1"`, если символ никогда не торговался<br>- Возвращает `seq`, обновленный последней транзакцией, когда есть настройки типа плеча, лимит риска |
