- [Информация](#информация)
- [Поток данных](#поток-данных)
- [Подписка](#подписка)
- [Примеры подписки](#примеры-подписки)
- [Пример ответа при удачной авторизации](#пример-ответа-при-удачной-авторизации)
- [Пример ответа при удачной подписки](#пример-ответа-при-удачной-подписки)
- [Пример получаемых данных](#пример-получаемых-данных)
- [Параметры получаемых данных](#параметры-получаемых-данных)

<a id="информация"></a>

Подписка на ленту новостей о кошельке, чтобы видеть изменения в нём в режиме реального времени.

>Информация:
>
>- В момент успешной подписки событие снимка не происходит.
>- Нереализованное изменение PnL не вызывает событие.

<a id="поток-данных"></a>

## Поток данных

`wallet`

<a id="подписка"></a>

## Подписка

```json
{
    "op": "subscribe",
    "args": [
        "wallet"
    ]
}
```

<a id="примеры-подписки"></a>

## Примеры подписки

- собственная реализация

  ```python
  import hmac
  import json
  import time
  import websocket
  
  url = "wss://stream-testnet.bybit.com/v5/private"
  api_key = "<api_key от биржи bybit>"
  api_secret = "<api_secret от биржи bybit>"
  
  def on_message(ws, message):
      try:
          data = json.loads(message)
          print(f"Полученное сообщение: {message}")
      except json.JSONDecodeError:
          print(f"Не удалось распарсить сообщение: {message}")
          return
  
      if data.get("op") == "auth" and data.get("success") is True:
          print("Аутентификация успешна. Отправляю подписку на 'position'")
          subscribe_request = {
              "op": "subscribe",
              "args": [
                  "wallet"
              ]
          }
          ws.send(json.dumps(subscribe_request))
  
  def on_error(ws, error):
      print(f"Ошибка: {error}")
  
  def on_close(ws, close_status_code, close_msg):
      print(f"Соединение закрыто: {close_status_code} {close_msg}")
  
  def on_open(ws):
      print("Соединение открыто")
  
      expires = int((time.time() + 1) * 1000)
      signature = str(hmac.new(
          key=api_secret.encode("utf-8"),
          msg=f"GET/realtime{expires}".encode("utf-8"),
          digestmod="sha256"
      ).hexdigest())
  
      auth_request = {
          "op": "auth",
          "args": [
              api_key,
              expires,
              signature
          ]
      }
      ws.send(json.dumps(auth_request))

      print("Запрос аутентификации отправлен")
  
  def run_websocket():
      while True:
          ws = websocket.WebSocketApp(url)
          ws.on_message = on_message
          ws.on_error = on_error
          ws.on_close = on_close
          ws.on_open = on_open
  
          ws.run_forever(
              ping_interval=20,
              ping_timeout=5
          )
  
          print("Соединение потеряно. Попытка переподключения...")
          time.sleep(5)
  
  run_websocket()
  ```

- pybit

  ```python
  from time import sleep

  from pybit.unified_trading import WebSocket

  ws = WebSocket(
      testnet=True,
      channel_type="private",
      api_key="<api_key от биржи bybit>",
      api_secret="<api_secret от биржи bybit>",
  )

  def handle_message(message):
      print(message)

  ws.wallet_stream(
    callback=handle_message
  )

  while True:
      sleep(1)
  ```

<a id="пример-ответа-при-удачной-авторизации"></a>

## Пример ответа при удачной авторизации

```json
{
    "success": true,
    "ret_msg": "",
    "op": "auth",
    "conn_id": "d266o6hqo29sqmnq4vk0-7ga4j"
}
```

<a id="пример-ответа-при-удачной-подписки"></a>

## Пример ответа при удачной подписки

```json
{
    "success": true,
    "ret_msg": "",
    "op": "subscribe",
    "conn_id": "d266oeddaugoadim24og-761j0"
}
```

<a id="пример-получаемых-данных"></a>

## Пример получаемых данных

```json
{
    "id": "592324d2bce751-ad38-48eb-8f42-4671d1fb4d4e",
    "topic": "wallet",
    "creationTime": 1700034722104,
    "data": [
        {
            "accountIMRate": "0",
            "accountIMRateByMp": "0",
            "accountMMRate": "0",
            "accountMMRateByMp": "0",
            "totalEquity": "10262.91335023",
            "totalWalletBalance": "9684.46297164",
            "totalMarginBalance": "9684.46297164",
            "totalAvailableBalance": "9556.6056555",
            "totalPerpUPL": "0",
            "totalInitialMargin": "0",
            "totalInitialMarginByMp": "0",
            "totalMaintenanceMargin": "0",
            "totalMaintenanceMarginByMp": "0",
            "coin": [
                {
                    "coin": "BTC",
                    "equity": "0.00102964",
                    "usdValue": "36.70759517",
                    "walletBalance": "0.00102964",
                    "availableToWithdraw": "0.00102964",
                    "availableToBorrow": "",
                    "borrowAmount": "0",
                    "accruedInterest": "0",
                    "totalOrderIM": "",
                    "totalPositionIM": "",
                    "totalPositionMM": "",
                    "unrealisedPnl": "0",
                    "cumRealisedPnl": "-0.00000973",
                    "bonus": "0",
                    "collateralSwitch": true,
                    "marginCollateral": true,
                    "locked": "0",
                    "spotHedgingQty": "0.01592413",
                    "spotBorrow": "0"
                }
            ],
            "accountLTV": "0",
            "accountType": "UNIFIED"
        }
    ]
}
```

<a id="параметры-получаемых-данных"></a>

## Параметры получаемых данных

|Параметр  |Тип       |Комментарии                                             |
|----------|----------|--------------------------------------------------------|
|id        |string    |Идентификатор сообщения                                             |
|topic     |string    |Название потока данных                                             |
|creationTime | number | Временная метка создания данных (в миллисекундах) |
|data | array | Массив объектов. |
|accountType | string | Тип аккаунта.<br>- [UTA2.0](<../../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-2.0>): `UNIFIED`<br>- [UTA1.0](<../../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>): `UNIFIED` (spot/linear/options), `CONTRACT`(inverse)<br>- Классический аккаунт: `CONTRACT`, `SPOT` |
|accountLTV | string | Устаревшее поле |
|accountIMRate   |string     |Базовая ставка начальной маржи по счёту<br><br>- Вы можете обратиться к [этому глоссарию](https://www.bybit.com/en/help-center/article/Glossary-Unified-Trading-Account), чтобы понять расчеты и значение полей ниже.<br>- Все поля, относятся ко всему аккаунту, кроме<br>&nbsp;&nbsp;&nbsp;- [UTA2.0](<../../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-2.0>) (изолированная маржа)<br>&nbsp;&nbsp;&nbsp;- [UTA1.0](<../../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>) (изолированная маржа, КОНТРАКТ)<br>&nbsp;&nbsp;&nbsp;- классический аккаунт (СПОТ, КОНТРАКТ)                                           |
|accountIMRateByMp | string | Базовая ставка начальной маржи по счёту рассчитывается по Mark Price<br><br>- Вы можете обратиться к [этому глоссарию](https://www.bybit.com/en/help-center/article/Glossary-Unified-Trading-Account), чтобы понять расчеты и значение полей ниже.<br>- Все поля, относятся ко всему аккаунту, кроме<br>&nbsp;&nbsp;&nbsp;- [UTA2.0](<../../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-2.0>) (изолированная маржа)<br>&nbsp;&nbsp;&nbsp;- [UTA1.0](<../../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>) (изолированная маржа, КОНТРАКТ)<br>&nbsp;&nbsp;&nbsp;- классический аккаунт (СПОТ, КОНТРАКТ)                                           |
|accountMMRateByMp | string | Базовая ставка поддерживающей маржи по счёту рассчитывается по Mark Price |
|totalEquity | string | Полный капитал аккаунта (USD)<br>`totalWalletBalance` + общий нереализованный PnL (от любых позиций: `Perpetual`, `spot`) |
|totalWalletBalance | string | Чистый баланс активов в кошельке (без PnL или маржи) (USD)  |
|totalMarginBalance | string | Баланс маржи (USD)<br>`TotalWalletBalance` + `totalPerpUPL` (PnL только от `Perpetual`). Узкий фокус на `Perpetual` для маржинальной торговли |
|totalAvailableBalance | string | Доступный баланс для кросс-маржи (USD)<br>`totalMarginBalance` - `totalInitialMargin` (сколько свободно для новых `Perpetual`) |
|totalPerpUPL | string | Нереализованный PnL только `Perpetual` и `futures` (USD)  |
|totalInitialMargin | string | Сумма начальной маржи по всем активам (USD)<br>Вычитается для расчёта доступной маржи в `totalAvailableBalance` |
|totalInitialMarginByMp | string | Сумма начальной маржи по по Mark Price (USD) |
|totalMaintenanceMargin | string | Общая сумма маржи поддержания (maintenance margin) по всем открытым позициям в аккаунте, рассчитанная по последней цене сделки, которая служит порогом для принудительной ликвидации позиций при падении капитала ниже неё (USD) |
|totalMaintenanceMarginByMp | string | Общая сумма маржи поддержания (maintenance margin) по всем открытым позициям в аккаунте, выраженная в USD и рассчитанная по Mark Price актива, которая служит более справедливым и стабильным порогом для принудительной ликвидации позиций, устойчивым к краткосрочным манипуляциям рынка (USD)  |
|coin | array | Массив объектов. |
|coin | string | Название монеты. |
|equity | string | Капитал монеты |
|usdValue | string | Стоимость монеты (USD)  |
|walletBalance | string | Баланс монет в кошельке |
|free | string | Доступный баланс для `spot`<br>Это уникальное поле для классического аккаунта (`spot`) |
|locked | string | Заблокированный баланс из-за открытого ордера `spot`  |
|spotHedgingQty | string | Количество спотовых активов, используемых для хеджирования маржи портфеля, округляется до 8 знаков после запятой и по умолчанию равно `0`.<br>Это уникальное поле для единого аккаунта |
|borrowAmount | string | Это сумма средств (в единицах текущего актива), которую вы заняли на бирже для открытия или увеличения позиций в маржинальной торговле |
|availableToBorrow | string | **Устарело.** Всегда возвращает `""` см. параметр `availableToBorrow` в разделе [Получить информацию об обеспечении](<../../Account/Получить информацию об обеспечении.md>)  |
|availableToWithdraw | string | Это поле устарело для `accountType`=UNIFIED с 9 января 2025 г.<br>- <b>Переводимый баланс:</b> вместо этого можно использовать [Получить сумму для перевода (Единый)](<../../Account/Получить сумму для перевода (Единый).md>) или [Get All Coins Balance](<../../Asset/Balances/Получить баланс всех монет.md>)<br>- <b>Доступный баланс деривативов:</b><br>&nbsp;&nbsp;&nbsp;- изолированная маржа: `walletBalance` - `totalPositionIM` -<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`totalOrderIM` - `locked` - `bonus`<br>&nbsp;&nbsp;&nbsp;- Кросс-маржа и портфельная маржа: см. поле<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`totalAvailableBalance`, которое необходимо преобразовать<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;в доступный баланс соответствующей монеты через Index Price<br>- <b>Доступный баланс спотовой (маржинальной) позиции:</b> см. раздел [Получить лимит займа на споте](<../../Trade/Получить лимит займа на споте.md>)  |
|accruedInterest | string | Начисленные проценты |
|totalOrderIM | string | Предварительно занятая маржа для ордера<br>В режиме портфельной маржи возвращается `""` |
|totalPositionIM | string | Сумма начальной маржи по всем позициям + комиссия за ликвидацию, рассчитанная заранее<br>Для режима портфельной маржи возвращается `""`  |
|totalPositionMM | string | Сумма маржи для поддержания всех позиций<br>В режиме портфельной маржи возвращается `""`  |
|unrealisedPnl | string | Нереализованные прибыли и убытки |
|cumRealisedPnl | string | Совокупная реализованная прибыль и убыток |
|bonus | string | Бонус<br>Это уникальное поле для типа `accountType`=UNIFIED.  |
|collateralSwitch | boolean | Включено ли обеспечение пользователем<br>Если `marginCollateral`=`true`, то `collateralSwitch` имеет смысл.<br>- Это уникальное поле для единого аккаунта |
|marginCollateral | boolean | Можно ли использовать его в качестве валюты маржинального обеспечения<br>Если `marginCollateral`=`true`, то `collateralSwitch` имеет смысл.<br>- Это уникальное поле для единого аккаунта |
|spotBorrow | string | Сумма займа по спотовой маржинальной сделке<br>Не включает сумму займа по активному ордеру спотовой маржи.<br> Поле `spotBorrow`, соответствующее спот-обязательствам, подробно описано в [анонсе](https://announcements.bybit.com/en/article/bybit-uta-function-optimization-manual-coin-borrowing-will-be-launched-soon-blt5d858199bd12e849/). |
