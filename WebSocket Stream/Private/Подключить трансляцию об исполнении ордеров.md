- [Информация](#информация)
- [Поток данных](#поток-данных)
- [Подписка](#подписка)
- [Примеры подписки](#примеры-подписки)
- [Пример ответа при удачной авторизации](#пример-ответа-при-удачной-авторизации)
- [Пример ответа при удачной подписки](#пример-ответа-при-удачной-подписки)
- [Пример получаемых данных](#пример-получаемых-данных)
- [Параметры получаемых данных](#параметры-получаемых-данных)

<a id="информация"></a>

Подписка на ленту данных об исполнении ордеров, чтобы наблюдать за исполнением ваших ордеров в режиме реального времени.

>Информация:
>
>- Поток данных `execution` и потоки данных `execution.spot`, `execution.linear`, `execution.inverse`,
> `execution.option` не могут находиться в одном запросе на подписку.
>- Поток данных `execution` позволяет прослушивать обновления WebSocket всех категорий
> (`spot`, `linear` `inverse` `option`).
>- Потоки данных `execution.spot`, `execution.linear`, `execution.inverse`, `execution.option` позволяют прослушивать
> обновления WebSocket только определённой категории.
<!-- -->
>Совет:
>
>В одном сообщении может быть указано несколько исполнений одного ордера.

<a id="поток-данных"></a>

## Поток данных

`execution`
`execution.spot`
`execution.linear`
`execution.inverse`
`execution.option`

<a id="подписка"></a>

## Подписка

```json
{
    "op": "subscribe",
    "args": [
        "execution"
    ]
}
```

<a id="примеры-подписки"></a>

## Примеры подписки

- собственная реализация

  ```python
  import hmac
  import json
  import time
  import websocket
  
  url = "wss://stream-testnet.bybit.com/v5/private"
  api_key = "<api_key от биржи bybit>"
  api_secret = "<api_secret от биржи bybit>"
  
  def on_message(ws, message):
      try:
          data = json.loads(message)
          print(f"Полученное сообщение: {message}")
      except json.JSONDecodeError:
          print(f"Не удалось распарсить сообщение: {message}")
          return
  
      if data.get("op") == "auth" and data.get("success") is True:
          print("Аутентификация успешна. Отправляю подписку на 'position'")
          subscribe_request = {
              "op": "subscribe",
              "args": [
                  "execution"
              ]
          }
          ws.send(json.dumps(subscribe_request))
  
  def on_error(ws, error):
      print(f"Ошибка: {error}")
  
  def on_close(ws, close_status_code, close_msg):
      print(f"Соединение закрыто: {close_status_code} {close_msg}")
  
  def on_open(ws):
      print("Соединение открыто")
  
      expires = int((time.time() + 1) * 1000)
      signature = str(hmac.new(
          key=api_secret.encode("utf-8"),
          msg=f"GET/realtime{expires}".encode("utf-8"),
          digestmod="sha256"
      ).hexdigest())
  
      auth_request = {
          "op": "auth",
          "args": [
              api_key,
              expires,
              signature
          ]
      }
      ws.send(json.dumps(auth_request))

      print("Запрос аутентификации отправлен")
  
  def run_websocket():
      while True:
          ws = websocket.WebSocketApp(url)
          ws.on_message = on_message
          ws.on_error = on_error
          ws.on_close = on_close
          ws.on_open = on_open
  
          ws.run_forever(
              ping_interval=20,
              ping_timeout=5
          )
  
          print("Соединение потеряно. Попытка переподключения...")
          time.sleep(5)
  
  run_websocket()
  ```

- pybit

  ```python
  from time import sleep

  from pybit.unified_trading import WebSocket

  ws = WebSocket(
      testnet=True,
      channel_type="private",
      api_key="<api_key от биржи bybit>",
      api_secret="<api_secret от биржи bybit>",
  )

  def handle_message(message):
      print(message)

  ws.execution_stream(
    callback=handle_message
  )

  while True:
      sleep(1)
  ```

<a id="пример-ответа-при-удачной-авторизации"></a>

## Пример ответа при удачной авторизации

```json
{
    "success": true,
    "ret_msg": "",
    "op": "auth",
    "conn_id": "d266o6hqo29sqmnq4vk0-7ga4j"
}
```

<a id="пример-ответа-при-удачной-подписки"></a>

## Пример ответа при удачной подписки

```json
{
    "success": true,
    "ret_msg": "",
    "op": "subscribe",
    "conn_id": "d266oeddaugoadim24og-761j0"
}
```

<a id="пример-получаемых-данных"></a>

## Пример получаемых данных

```json
{
    "topic": "execution",
    "id": "386825804_BTCUSDT_140612148849382",
    "creationTime": 1746270400355,
    "data": [
        {
            "category": "linear",
            "symbol": "BTCUSDT",
            "closedSize": "0.5",
            "execFee": "26.3725275",
            "execId": "0ab1bdf7-4219-438b-b30a-32ec863018f7",
            "execPrice": "95900.1",
            "execQty": "0.5",
            "execType": "Trade",
            "execValue": "47950.05",
            "feeRate": "0.00055",
            "tradeIv": "",
            "markIv": "",
            "blockTradeId": "",
            "markPrice": "95901.48",
            "indexPrice": "",
            "underlyingPrice": "",
            "leavesQty": "0",
            "orderId": "9aac161b-8ed6-450d-9cab-c5cc67c21784",
            "orderLinkId": "",
            "orderPrice": "94942.5",
            "orderQty": "0.5",
            "orderType": "Market",
            "stopOrderType": "UNKNOWN",
            "side": "Sell",
            "execTime": "1746270400353",
            "isLeverage": "0",
            "isMaker": false,
            "seq": 140612148849382,
            "marketUnit": "",
            "execPnl": "0.05",
            "createType": "CreateByUser",
            "extraFees":[{"feeCoin":"USDT","feeType":"GST","subFeeType":"IND_GST","feeRate":"0.0000675","fee":"0.006403779"}],
            "feeCurrency": "USDT"
        }
    ]
}
```

<a id="параметры-получаемых-данных"></a>

## Параметры получаемых данных

|Параметр  |Тип       |Комментарии                                             |
|----------|----------|--------------------------------------------------------|
|id        |string    |Идентификатор сообщения                                             |
|topic     |string    |Название потока данных                                             |
|creationTime | number | Временная метка создания данных (в миллисекундах) |
|data | array | Массив объектов. |
|[category](<../../19.Определения значений в запросах и ответах.md#category>) | string | Тип продукта<br><br>- [UTA2.0](<../../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-2.0>), [UTA1.0](<../../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>): `spot`, `linear`, `inverse`, `option`<br>- Классический аккаунт: `spot`, `linear`, `inverse`. |
|symbol | string | Название символа |
|isLeverage | string | Будет ли заем.<br><br>- Единый аккаунт `spot`. `0`: false, `1`: true<br>- Классический аккаунт `linear`, `inverse`, `option`, всегда_ `0` |
|orderId | string | Идентификатор ордера |
|orderLinkId | string | Пользовательский идентификатор ордера |
|side | string | Сторона. `Buy`,`Sell` |
|orderPrice | string | Цена ордера. Классический аккаунт `spot` не поддерживается |
|orderQty | string | Количество ордера. Классический аккаунт `spot` не поддерживается |
|leavesQty | string | Оставшееся не исполненное количество . Классический аккаунт `spot` не поддерживается |
|[createType](<../../19.Определения значений в запросах и ответах.md#createType>) | string | Тип создания ордера<br><br>- Классический аккаунт и [UTA1.0](<../../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-1.0>)(`category`=`inverse`): всегда `""`<br>- `spot`, `option` не имеют этого ключа |
|[orderType](<../../19.Определения значений в запросах и ответах.md#orderType>) | string | Тип ордера. `Market`,`Limit`. Классический аккаунт `spot` не поддерживается |
|[stopOrderType](<../../19.Определения значений в запросах и ответах.md#stopOrderType>) | string | Тип стоп-ордера. Классический аккаунт `spot` не поддерживается |
|execFee | string | Исполненная торговая комиссия. Вы можете получить инструкцию по валюте комиссии spot [здесь](<../../19.Определения значений в запросах и ответах.md#Spot Fee Currency Instruction>). Классический аккаунт `spot` не поддерживается |
|execId | string | Идентификатор исполнения |
|execPrice | string | Цена исполнения |
|execQty | string | Количество исполнения |
|execPnl | string | Прибыль и убыток за каждое исполнение закрытия позиции. Значение соответствует полю `cashFlow` в [Получить журнал транзакций (Единый)](<../../Account/Получить журнал транзакций (Единый).md>) |
|[execType](<../../19.Определения значений в запросах и ответах.md#execType>) | string | Тип исполнения. Классический аккаунт `spot` не поддерживается |
|execValue | string | Значение исполненного ордера. Классический аккаунт `spot` не поддерживается |
|execTime | string | Временная метка исполнения (в миллисекундах) |
|isMaker | boolean | Является ли исполненный ордер maker order. `true`: maker, `false`: taker |
|feeRate | string | Ставка торговой комиссии. Классический аккаунт `spot` не поддерживается |
|tradeIv | string | Подразумеваемая волатильность. Действительно для `option` |
|markIv | string | Подразумеваемая волатильность цены маркировки. Действительно для `option` |
|markPrice | string | Цена Mark Price символа при исполнении. Действительно для `option` |
|indexPrice | string | Цена Index Price цена символа при исполнении. Действительно для `option` |
|underlyingPrice | string | Базовая цена символа при исполнении. Действительно для `option` |
|blockTradeId | string | Идентификатор блока торговли |
|closedSize | string | Размер закрытой позиции |
|extraFees   |string      |Информация о ставке торговой комиссии.<br>В настоящее время эти данные возвращаются только для спотовых ордеров, размещенных на индонезийской площадке, или спотовых ордеров в фиатной валюте, размещенных на площадке ЕС. В остальных случаях возвращается пустая строка.<br>Перечисление: [feeType](<../../19.Определения значений в запросах и ответах.md#extraFees-feeType>), [subFeeType](<../../19.Определения значений в запросах и ответах.md#extraFees-subFeeType>)                                            |
|seq  |long      |Перекрёстная последовательность, используемая для связывания каждого исполнения и каждого обновления позиции<br><br>- Последовательность будет одинаковой при одновременном<br>&nbsp;&nbsp;&nbsp;заключении нескольких сделок.<br>- Разные символы могут иметь одинаковую последовательность.<br>&nbsp;&nbsp;&nbsp;Используйте seq + symbol для проверки уникальности. |
|feeCurrency | string | Валюта торговой комиссии   |
