- [Информация](#информация)
- [Поток данных](#поток-данных)
- [Запрос](#запрос)
- [Примеры запроса](#примеры-запроса)
- [Параметры запроса](#параметры-запроса)
- [Пример ответа при удачной авторизации](#пример-ответа-при-удачной-авторизации)
- [Пример ответа](#пример-ответа)
- [Параметры ответа](#параметры-ответа)

<a id="информация"></a>

## Информация

Подписка на размещение пакета ордеров

> Зона применения:  
>
> `spot` - спот  
> `option` - опцион  
> `linear` - контракт (расчет в USDT, USDC, ...)
>
> - `Perpetual` - контракт без даты экспирации
> - `Futures` - контракт с датой экспирации
>
> `inverse` - контракт (расчет в BTC, ETH, ...) !!! только [UTA2.0](</13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-2.0>)
>
> - `Perpetual` - контракт без даты экспирации
> - `Futures` - контракт с датой экспирации
<!-- -->
> Информация:
>
> - В одном запросе можно разместить максимум 20 ордеров (`option`), 20 ордеров (`inverse`), 20 ордеров (`linear`) и 10
>   ордеров (`spot`). Возвращаемый список данных разделён на два списка. Первый список указывает, был ли создан ордер,
>   а второй содержит информацию о созданном ордере. Структура двух списков полностью идентична.
> - Инструкция ограничения скорости опциона: её ограничение рассчитывается на основе фактического количества
>   отправленных запросов. Например, по умолчанию ограничение скорости торговли `option` составляет 10 запросов
>   в секунду, поэтому вы можете отправить до 20 * 10 = 200 ордеров в секунду.
> - Инструкция ограничения скорости `inverse`, `linear` и `spot` ордеров, см.
>   [здесь](</Лимиты по запросам/Лимиты общее.md>).  
> - Ограничение скорости счета распределяется между ордерами WebSocket и пакетными ордерами HTTP.  
> - Подтверждение пакетных запросов на создание/изменение/отмену ордеров означает, что запрос был успешно принят.  
> - Запрос асинхронный, поэтому для подтверждения статуса ордера используйте WebSocket.

<a id="поток-данных"></a>

## Поток данных

`order.create-batch`\
`order.amend-batch`\
`order.cancel-batch`

<a id="запрос"></a>

## Запрос

```json

{
    "op": "order.create-batch",
    "header": {
        "X-BAPI-TIMESTAMP": time_stamp,
        "X-BAPI-RECV-WINDOW": "1000"
    },
    "args": [
        {
            "category": "linear",
            "request": [
                {
                      "symbol": "SOLUSDT",
                      "side": "Sell",
                      "orderType": "Market",
                      "qty": "0.1"
                },
                {
                      "symbol": "ETHUSDT",
                      "side": "Sell",
                      "orderType": "Market",
                      "qty": "0.01"
                }
            ]
        }
    ]
}
```

<a id="примеры-запроса"></a>

## Примеры запроса

- собственная реализация

  ```python
  import os
  import hmac
  import json
  import time
  import websocket

  url = "wss://stream-testnet.bybit.com/v5/trade"
  api_key = "<api_key от биржи bybit>"
  api_secret = "<api_secret от биржи bybit>"

  def on_message(ws, message):
      try:
          data = json.loads(message)
          print(f"Полученное сообщение: {message}")
      except json.JSONDecodeError:
          print(f"Не удалось распарсить сообщение: {message}")
          return

      if data.get("op") == "auth" and data.get("retMsg") == "OK":
          print("Аутентификация успешна. Размещаю ордер на покупку")
          time_stamp = str(int(time.time() * 1000))
          request_create_order = {
              "op": "order.create-batch",
              "header": {
                  "X-BAPI-TIMESTAMP": time_stamp,
                  "X-BAPI-RECV-WINDOW": "1000"
              },
              "args": [
                  {
                      "category": "linear",
                      "request": [
                          {
                              "symbol": "SOLUSDT",
                              "side": "Sell",
                              "orderType": "Market",
                              "qty": "0.1"
                          },
                          {
                              "symbol": "ETHUSDT",
                              "side": "Sell",
                              "orderType": "Market",
                              "qty": "0.01"
                          }
                      ]
                  }
              ]
          }
          ws.send(json.dumps(request_create_order))

  def on_error(ws, error):
      print(f"Ошибка: {error}")

  def on_close(ws, close_status_code, close_msg):
      print(f"Соединение закрыто: {close_status_code} {close_msg}")

  def on_open(ws):
      print("Соединение открыто")
      expires = int((time.time() + 1) * 1000)
      signature = str(hmac.new(
          key=api_secret.encode("utf-8"),
          msg=f"GET/realtime{expires}".encode("utf-8"),
          digestmod="sha256"
      ).hexdigest())

      auth_request = {
          "op": "auth",
          "args": [
              api_key,
              expires,
              signature
          ]
      }
      ws.send(json.dumps(auth_request))

      print("Запрос аутентификации отправлен")

  def run_websocket():
      while True:
          ws = websocket.WebSocketApp(url)
          ws.on_message = on_message
          ws.on_error = on_error
          ws.on_close = on_close
          ws.on_open = on_open

          ws.run_forever(
              ping_interval=20,
              ping_timeout=5
          )

          print("Соединение потеряно. Попытка переподключения...")
          time.sleep(5)

  run_websocket()
  ```

<a id="параметры-запроса"></a>

## Параметры запроса

| Параметр              | Обязательный  | Тип       | Комментарии                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | По умолчанию |
|-----------------------|---------------|-----------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------|
| reqId                 | нет           | string    | ***Используется для определения уникальности запроса и возвращается в ответе при передаче.***<br><br>- Длина не может превышать 36 символов<br>- Если передан, он не может быть продублирован, иначе вы получите код ошибки `20006`                                                                                                                                                                                                                                                         | -            |
| header                | да            | object    | ***Заголовки запроса.***                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | -            |
| X-BAPI-TIMESTAMP      | да            | string    | ***Текущая временная метка.***                                                                                                                                                                                                                                                                                                                                                                                                                                                              | -            |
| X-BAPI-RECV-WINDOW    | нет           | string    | ***Запрос будет отклонен, если не будет соответствовать правилу:***<br>Bybit_server_time - `X-BAPI-RECV-WINDOW` <= `X-BAPI-TIMESTAMP` < Bybit_server_time + 1000                                                                                                                                                                                                                                                                                                                            | `5000`       |
| Referer               | нет           | string    | ***Идентификатор реферера для пользователя API-брокера***                                                                                                                                                                                                                                                                                                                                                                                                                                   | -            |
| op                    | да            | string    | ***Тип операции.***<br><br>- `order.create-batch`: создать ордер<br>- `order.amend-batch`: изменить ордер<br>- `order.cancel-batch`: отменить ордер                                                                                                                                                                                                                                                                                                                                         | -            |
| args                  | да            | array     | ***Массив аргументов.***<br><br>- `order.create-batch`: ссылка на таблицу параметров запроса при [Разместить пакет ордеров](</Trade/Разместить пакет ордеров.md#параметры-запроса>)<br>- `order.amend-batch`: ссылка на таблицу параметров запроса при [Изменить пакетно ордера](</Trade/Изменить пакетно ордера.md#параметры-запроса>)<br>- `order.cancel-batch`: ссылка на таблицу параметров запроса при [Отменить пакет ордеров](</Trade/Отменить пакетно ордера.md#параметры-запроса>) | -            |

<a id="пример-ответа-при-удачной-авторизации"></a>

## Пример ответа при удачной авторизации

```json
{
    "retCode": 0,
    "retMsg": "OK",
    "op": "auth",
    "connId": "cnt5leec0hvan15eukcg-2t"
}
```

<a id="пример-ответа"></a>

## Пример ответа

```json
{
    "retCode": 0,
    "retMsg": "OK",
    "op": "order.create-batch",
    "data": {
        "list": [
            {
                "category": "linear",
                "symbol": "SOLUSDT",
                "orderId": "",
                "orderLinkId": "batch-000",
                "createAt": ""
            },
            {
                "category": "linear",
                "symbol": "ETHUSDT",
                "orderId": "",
                "orderLinkId": "batch-001",
                "createAt": ""
            }
        ]
    },
    "retExtInfo": {
        "list": [
            {
                "code": 10001,
                "msg": "position idx not match position mode"
            },
            {
                "code": 10001,
                "msg": "position idx not match position mode"
            }
        ]
    },
    "header": {
        "X-Bapi-Limit": "150",
        "X-Bapi-Limit-Status": "147",
        "X-Bapi-Limit-Reset-Timestamp": "1740453408555",
        "Traceid": "0e32b551b3e17aae77651aadf6a5be80",
        "Timenow": "1740453408556"
    },
    "connId": "cupviqn88smf24t2kpb0-536o"
}
```

<a id="параметры-ответа"></a>

## Параметры ответа

| Параметр                     | Тип     | Комментарии                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|------------------------------|---------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| reqId                        | string  | - Если передано в запросе, то возвращается в ответе<br>- Если не передано, то не возвращается в ответе                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| retCode                      | integer | - `0`: успешно<br>- `10403`: превышено ограничение скорости IP-адресов. 3000 запросов в секунду на IP-адрес<br>- `10404`: 1. тип операции не найден; 2. категория неверна/не поддерживается<br>- `10429`: защита частоты на системном уровне<br>- `20006`: reqId дублируется<br>- `10016`: 1. внутренняя ошибка сервера; 2. служба перезапускается<br>- `10019`: служба ws trade перезапускается, новые запросы не принимаются, но текущий запрос не затрагивается. Вы можете создать новое соединение для маршрутизации в обычную службу |
| retMsg                       | string  | - `OK`<br>- `""`<br>- сообщение об ошибки                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| op                           | string  | ***Тип операции.***                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| data                         | object  | ***Данные по ордеру.***<br><br>- `order.create-batch`: ссылка на таблицу параметров ответа при [Разместить пакет ордеров](</Trade/Разместить пакет ордеров.md#параметры-ответа>)<br>- `order.amend-batch`: ссылка на таблицу параметров ответа при [Изменить пакетно ордера](</Trade/Изменить пакетно ордера.md#параметры-ответа>)<br>- `order.cancel-batch`: ссылка на таблицу параметров ответа при [Отменить пакетно ордера](</Trade/Отменить пакетно ордера.md#параметры-ответа>)                                                     |
| retExtInfo                   | object  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| list                         | array   | ***Массив объектов.***                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| code                         | number  | ***Код об успехе/ошибке.***                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| msg                          | string  | ***Сообщение об успехе/ошибке.***                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| header                       | object  | ***Информация заголовка.***                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| TraceId                      | string  | ***Идентификатор трассировки.***<br><br>- Используемый для отслеживания истории запроса                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| Timenow                      | string  | ****Текущая временная метка.****                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| X-Bapi-Limit                 | string  | ***Общий лимит ставки текущего счета для этого типа операции.***                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| X-Bapi-Limit-Status          | string  | ***Оставшийся лимит ставки текущего счета для этого типа операции.***                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| X-Bapi-Limit-Reset-Timestamp | string  | ***Метка времени указывает, когда ваш лимит запросов сбрасывается, если вы превысили его.***<br><br>- В противном случае это просто текущая метка времени (она может не совпадать с `timeNow`).                                                                                                                                                                                                                                                                                                                                           |
| connId                       | string  | ***Идентификатор подключения.***<br><br>- Уникальный идентификатор подключения                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
