- [Информация](#информация)
- [Поток данных](#поток-данных)
- [Запрос](#запрос)
- [Примеры запроса](#примеры-запроса)
- [Параметры запроса](#параметры-запроса)
- [Пример ответа при удачной подписки](#пример-ответа-при-удачной-подписки)
- [Пример ответа](#пример-ответа)
- [Параметры ответа](#параметры-ответа)

<a id="информация"></a>

Подписка на размещение ордера

>Зона применения:  
>
>`spot` - спот  
>`option` - опцион  
>`linear` - контракт (расчет в USDT, USDC, ...)
>
> - `Perpetual` - контракт без даты экспирации
> - `Futures` - контракт с датой экспирации
>
>`inverse` - контракт (расчет в BTC, ETH, ...) !!! только [UTA2.0](<../13.Различные режимы аккаунтов.md#единый-торговый-аккаунт-2.0>)
>
> - `Perpetual` - контракт без даты экспирации
> - `Futures` - контракт с датой экспирации

<a id="поток-данных"></a>

## Поток данных

`order.create`  
`order.amend`  
`order.cancel`  

<a id="запрос"></a>

## Запрос

```json
{
    "op": "order.create",
    "header": {
        "X-BAPI-TIMESTAMP": time_stamp,
        "X-BAPI-RECV-WINDOW": "8000"
    },
    "args": [
        {
            "category": "linear",
            "symbol": "ETHUSDT",
            "side": "Sell",
            "orderType": "Market",
            "qty": "0.01"
        }
    ]
}
```

<a id="примеры-запроса"></a>

## Примеры запроса

- собственная реализация

  ```python
  import os
  import hmac
  import json
  import time
  import websocket

  url = "wss://stream-testnet.bybit.com/v5/trade"
  api_key = "<api_key от биржи bybit>"
  api_secret = "<api_secret от биржи bybit>"

  def on_message(ws, message):
      try:
          data = json.loads(message)
          print(f"Полученное сообщение: {message}")
      except json.JSONDecodeError:
          print(f"Не удалось распарсить сообщение: {message}")
          return

      if data.get("op") == "auth" and data.get("retMsg") == "OK":
          print("Аутентификация успешна. Размещаю ордер на покупку")
          time_stamp = str(int(time.time() * 1000))
          request_create_order = {
              "op": "order.create",
              "header": {
                  "X-BAPI-TIMESTAMP": time_stamp,
                  "X-BAPI-RECV-WINDOW": "5000"
              },
              "args": [
                  {
                      "category": "linear",
                      "symbol": "ETHUSDT",
                      "side": "Sell",
                      "orderType": "Market",
                      "qty": "0.01"
                  }
              ]
          }
          ws.send(json.dumps(request_create_order))

  def on_error(ws, error):
      print(f"Ошибка: {error}")

  def on_close(ws, close_status_code, close_msg):
      print(f"Соединение закрыто: {close_status_code} {close_msg}")

  def on_open(ws):
      print("Соединение открыто")
      expires = int((time.time() + 1) * 1000)
      signature = str(hmac.new(
          key=api_secret.encode("utf-8"),
          msg=f"GET/realtime{expires}".encode("utf-8"),
          digestmod="sha256"
      ).hexdigest())

      auth_request = {
          "op": "auth",
          "args": [
              api_key,
              expires,
              signature
          ]
      }
      ws.send(json.dumps(auth_request))

      print("Запрос аутентификации отправлен")

  def run_websocket():
      while True:
          ws = websocket.WebSocketApp(url)
          ws.on_message = on_message
          ws.on_error = on_error
          ws.on_close = on_close
          ws.on_open = on_open

          ws.run_forever(
              ping_interval=20,
              ping_timeout=5
          )

          print("Соединение потеряно. Попытка переподключения...")
          time.sleep(5)

  run_websocket()
  ```

<a id="параметры-запроса"></a>

## Параметры запроса

|Параметр  	                  |Обязательный	 |Тип  	  |Комментарии             |По умолчанию|
|-----------------------------|--------------|--------|------------------------|------------|
|reqId  	                              |нет	 |string  	  |Используется для определения уникальности запроса и возвращается в ответе при передаче.<br>Длина не может превышать 36 символов.<br>Если передан, он не может быть продублирован, иначе вы получите код ошибки `20006`.             |-   |
|header  	                              |да	 |object  	  |Заголовки запроса             |-   |
|X-BAPI-TIMESTAMP  	                      |да	 |string  	  |Текущая временная метка             |-   |
|X-BAPI-RECV-WINDOW  	                  |нет	 |string  	  |Запрос будет отклонен, если не будет соответствовать правилу: Bybit_server_time - `X-BAPI-RECV-WINDOW` <= `X-BAPI-TIMESTAMP` < Bybit_server_time + 1000.             |`5000`   |
|Referer  	                              |нет	 |string  	  |Идентификатор реферера для пользователя API-брокера             |-   |
|op  	                                  |да	 |string  	  |Тип операции<br><br>`order.create`: создать ордер<br>`order.amend`: изменить ордер<br>`order.cancel`: отменить ордер             |-   |
|args               	                  |да	 |array  	  |Массив аргументов<br><br>На данный момент поддерживается только один элемент.<br>`order.create`: ссылка на таблицу параметров запроса при [Разместить ордер](<../../Trade/Разместить ордер.md#параметры-запроса>).<br>`order.amend`: ссылка на таблицу параметров запроса при [Изменить ордер](<../../Trade/Изменить ордер.md#параметры-запроса>).<br>`order.cancel`: ссылка на таблицу параметров запроса при [Отменить ордер](<../../Trade/Отменить ордер.md#параметры-запроса>).             |-   |

<a id="пример-ответа-при-удачной-подписки"></a>

## Пример ответа при удачной подписки

```json
{
    "retCode": 0,
    "retMsg": "OK",
    "op": "auth",
    "connId": "cnt5leec0hvan15eukcg-2t"
}
```

<a id="пример-ответа"></a>

## Пример ответа

```json
{
    "retCode": 0,
    "retMsg": "OK",
    "op": "order.create",
    "data": {
        "orderId": "a4c1718e-fe53-4659-a118-1f6ecce04ad9",
        "orderLinkId": ""
    },
    "retExtInfo": {},
    "header": {
        "X-Bapi-Limit": "10",
        "X-Bapi-Limit-Status": "9",
        "X-Bapi-Limit-Reset-Timestamp": "1711001595208",
        "Traceid": "38b7977b430f9bd228f4b19724794dfd",
        "Timenow": "1711001595209"
    },
    "connId": "cnt5leec0hvan15eukcg-2v"
}
```

<a id="параметры-ответа"></a>

## Параметры ответа

|Параметр  |Тип       |Комментарии                                             |
|----------|----------|--------------------------------------------------------|
|reqId      |string      |Если передано в запросе, то возвращается в ответе.<br>Если не передано, то не возвращается в ответе.                                             |
|retCode   |integer      |`0`: успешно<br>`10403`: превышено ограничение скорости IP-адресов. 3000 запросов в секунду на IP-адрес.<br>`10404`: 1. тип операции не найден; 2. категория неверна/не поддерживается.<br>`10429`: защита частоты на системном уровне.<br>`20006`: reqId дублируется.<br>`10016`: 1. внутренняя ошибка сервера; 2. служба перезапускается.<br>`10019`: служба ws trade перезапускается, новые запросы не принимаются, но текущий запрос не затрагивается. Вы можете создать новое соединение для маршрутизации в обычную службу.                                             |
|retMsg   |string      |`OK`,`""` или сообщение об ошибки                                             |
|op   |string      |Тип операции                                             |
|data   |object      |Данные по ордеру<br>`order.create`: ссылка на таблицу параметров ответа при [Разместить ордер](<../../Trade/Разместить ордер.md#параметры-ответа>)<br>`order.amend`: ссылка на таблицу параметров ответа при [Изменить ордер](<../../Trade/Изменить ордер.md#параметры-ответа>)<br>`order.cancel`: ссылка на таблицу параметров ответа при [Отменить ордер](<../../Trade/Отменить ордер.md#параметры-ответа>)                                             |
|retExtInfo   |object      |Всегда пустой объект                                             |
|header   |object      |Информация заголовка                                             |
|TraceId   |string      |Идентификатор трассировки, используемый для отслеживания истории запроса                          |
|Timenow   |string      |Текущая временная метка                                             |
|X-Bapi-Limit   |string      |Общий лимит ставки текущего счета для этого типа операции                                             |
|X-Bapi-Limit-Status   |string      |Оставшийся лимит ставки текущего счета для этого типа операции                                             |
|X-Bapi-Limit-Reset-Timestamp   |string      |Метка времени указывает, когда ваш лимит запросов сбрасывается, если вы превысили его. В противном случае это просто текущая метка времени (она может не совпадать с `timeNow`).                                             |
|connId   |string      |Идентификатор подключения, уникальный идентификатор подключения                                             |
