- [Информация](#информация)
- [Авторизация](#авторизация)
- [Лимиты IP](#лимиты-ip)
- [Лимиты аргументов публичного канала](#лимиты-аргументов-публичного-канала)
- [Как отправить пакет Heartbeat](#как-отправить-пакет-Heartbeat)
- [Как подписаться на поток данных](#как-подписаться-на-поток-данных)
  - [Понимание фильтров WebSocket: Подписка](#понимание-фильтров-webSocket-подписка)
  - [Понимание фильтров WebSocket: Отписка](#понимание-фильтров-webSocket-отписка)
- [Понимание ответа на подписку](#понимание-ответа-на-подписку)

<a id="информация"></a>

### Публичный поток WebSocket

- **Mainnet**

  Spot: `wss://stream.bybit.com/v5/public/spot`  
  USDT, USDC perpetual & USDT Futures: `wss://stream.bybit.com/v5/public/linear`  
  Inverse contract: `wss://stream.bybit.com/v5/public/inverse`  
  Spread trading: `wss://stream.bybit.com/v5/public/spread`  
  USDT/USDC Options: `wss://stream.bybit.com/v5/public/option`  

- **Testnet**

  Spot: `wss://stream-testnet.bybit.com/v5/public/spot`  
  USDT,USDC perpetual & USDT Futures: `wss://stream-testnet.bybit.com/v5/public/linear`  
  Inverse contract: `wss://stream-testnet.bybit.com/v5/public/inverse`  
  Spread trading: `wss://stream-testnet.bybit.com/v5/public/spread`  
  USDT/USDC Options: `wss://stream-testnet.bybit.com/v5/public/option`  

### Приватный поток WebSocket

- **Mainnet**

  `wss://stream.bybit.com/v5/private`

- **Testnet**

  `wss://stream-testnet.bybit.com/v5/private`

### Размещение ордеров через WebSocket

- **Mainnet**

  `wss://stream.bybit.com/v5/trade` (Spread trading не поддерживается)

- **Testnet**

  `wss://stream-testnet.bybit.com/v5/trade` (Spread trading не поддерживается)

### Получение статуса системы через WebSocket

- **Mainnet**

  `wss://stream.bybit.com/v5/public/misc/status`

- **Testnet**

  `wss://stream-testnet.bybit.com/v5/public/misc/status`

>Информация:
>
>- Если ваш аккаунт зарегистрирован на [www.bybit-tr.com](http://www.bybit-tr.com/), используйте `stream.bybit-tr.com`
> для доступа к основной сети.  
>- Если ваш аккаунт зарегистрирован на [www.bybit.kz,](http://www.bybit.kz/) используйте `stream.bybit.kz` для доступа
> к основной сети.  
>- Если ваш аккаунт зарегистрирован на [www.bybitgeorgia.ge](http://www.bybitgeorgia.ge/), используйте
> `stream.bybitgeorgia.ge` для доступа к основной сети.  
<!-- -->
>Настройка времени жизни приватного соединения:
>
>- Для приватного потока и ввода ордеров вы можете настроить время жизни соединения, добавив параметр `max_active_time`.
> Минимальное значение — `30s`, максимальное — `600s`. Вы также можете передавать значения типа `1m`, `2m` и т.д. для
> настройки в минутах. Например: `wss://stream-testnet.bybit.com/v5/private?max_active_time=1m`.  
>- В общем случае, если нет "ping-pong" и данных потока от сервера, соединение будет разорвано через 10 минут. Если
> у вас есть особые потребности, вы можете настроить время жизни соединения с помощью `max_active_time`.  
>- Поскольку сканирование тикера происходит каждые 30s, это не совсем точно. Например, если вы настроите 45s, и ваше
> последнее обновление или ping-pong произошло в `2023-08-15 17:27:23`, отключение может произойти
> в `2023-08-15 17:28:15`.  

<a id="авторизация"></a>

## Авторизация

>Информация:
>
>Публичные топики не требуют аутентификации. Следующий раздел относится только к приватным топикам.  

Применяйте аутентификацию при установке соединения.  

Примечание: если вы используете `pybit`, `bybit-api` или другую высокоуровневую библиотеку, вы можете игнорировать
этот код — аутентификация обрабатывается за вас.  

```json
{
    "req_id": "10001", // необязательный
    "op": "auth",
    "args": [
        "api_key",
        "expires",
        "signature"
    ]
}
```

```python
# based on: https://github.com/bybit-exchange/pybit/blob/master/pybit/_http_manager.py

import hmac
import json
import time
import websocket


API_KEY = "<api_key от биржи bybit>"
API_SECRET = "<api_secret от биржи bybit>"

# Подключаемся к приватному потоку WebSocket testnet
URL = "wss://stream-testnet.bybit.com/v5/private"

# Рассчитывает срок действия запроса (на 1 секунду в будущем) в миллисекундах.
expires = int((time.time() + 1) * 1000)

# Подпись.
signature = str(hmac.new(
    key=API_SECRET.encode("utf-8"),
    msg=f"GET/realtime{expires}".encode("utf-8"),
    digestmod="sha256"
).hexdigest())


# Функции срабатывает при получении сообщения от сервера. Выводит сообщение в консоль.
def on_message(ws, message):
    print("Received message:", message)

# Функции срабатывает при ошибках. Выводит ошибку в консоль.
def on_error(ws, error):
    print("Error:", error)

# Функции срабатывает при закрытии соединения, выводит информацию о закрытии.
def on_close(ws, close_status_code, close_msg):
    print("Connection closed", close_msg, close_status_code)

# Функции срабатывает при успешном подключении к WebSocket.
# Здесь происходит аутентификация, отправляя на сервер запрос с API ключом и подписью.
def on_open(ws):
    # Аутентификация с помощью API.
    ws.send(
        json.dumps(
            {
                "op": "auth",
                "args": [
                  API_KEY,
                  expires,
                  signature]
            }
        )
    )

# Создаёт экземпляр приложения WebSocket
ws = websocket.WebSocketApp(
    url=URL,
    on_message=on_message,
    on_error=on_error,
    on_close=on_close,
    on_open=on_open
)

# Запускает клиент WebSocket, который будет работать вечно, ожидая и обрабатывая события.
ws.run_forever()
```

Пример успешного ответа на аутентификацию  

```json
{
    "success": true,
    "ret_msg": "",
    "op": "auth",
    "conn_id": "cejreaspqfh3sjdnldmg-p"
}
```

>Примечание:
>
>Примеры алгоритмов подписи можно найти [здесь](https://github.com/bybit-exchange/api-usage-examples).  
<!-- -->
>Предупреждение:
>
>Из-за сложности сети ваше соединение может быть разорвано в любое время. Пожалуйста, следуйте инструкциям ниже,
> чтобы своевременно получать сообщения WebSocket:  
>
>- Поддерживайте соединение активным, отправляя [пакет heartbeat](#)  
>- Переподключайтесь как можно скорее при отключении  

<a id="лимиты-ip"></a>

## Лимиты IP

- Не подключайтесь и не отключайтесь слишком часто.  
- Не создавайте более 500 соединений за 5 минут. Это считается для каждого домена WebSocket.  

<a id="лимиты-аргументов-публичного-канала"></a>

## Лимиты аргументов публичного канала

Независимо от `Perpetual`, `Futures`, `Options` или `Spot`, для одного публичного соединения длина массива "args"
не может превышать 21 000 символов.  

- `Spot` может принимать до 10 args для каждого запроса подписки, отправленного на одно соединение  
- `Options` могут принимать до 2000 args для одного соединения  
- `Futures` и `Spread` нет лимита args на данный момент  

<a id="как-отправить-пакет-Heartbeat"></a>

## Как отправить пакет Heartbeat  

Как отправить ping

```python
# req_id — это настраиваемый идентификатор, который не является обязательным

ws.send(
    JSON.stringify(
        {
            "req_id": "100001",
            "op": "ping"
        }
    )
)
```

Пример сообщения pong для публичных каналов  

##### Spot

```json
{
    "success": true,
    "ret_msg": "pong",
    "conn_id": "0970e817-426e-429a-a679-ff7f55e0b16a",
    "op": "ping"
}
```

##### Linear/Inverse

```json
{
    "success": true,
    "ret_msg": "pong",
    "conn_id": "465772b1-7630-4fdc-a492-e003e6f0f260",
    "req_id": "",
    "op": "ping"
}
```

##### Option/Spread

```json
{
    "args": [
        "1672916271846"
    ],
    "op": "pong"
}
```

Пример сообщения pong для приватных каналов  

##### Spot/Linear/Inverse/Option/Spread

```json
{
    "req_id": "test",
    "op": "pong",
    "args": [
        "1675418560633"
    ],
    "conn_id": "cfcb4ocsvfriu23r3er0-1b"
}
```

>Предупреждение:
>
>Чтобы избежать проблем с сетью или программой, мы рекомендуем отправлять пакет ping heartbeat каждые 20 секунд для
> поддержания соединения WebSocket.  

<a id="как-подписаться-на-поток-данных"></a>

## Как подписаться на поток-данных  

<a id="понимание-фильтров-webSocket-подписка"></a>

### Понимание фильтров WebSocket: Подписка

```json
// подписка на orderbook глубина 1 символ BTCUSDT

{
    "req_id": "test", // необязательный
    "op": "subscribe",
    "args": [
        "orderbook.1.BTCUSDT"
    ]
}
```

Поддерживается подписка на несколько символов и топиков.  

```json
{
    "req_id": "test", // необязательный
    "op": "subscribe",
    "args": [
        "orderbook.1.BTCUSDT",
        "publicTrade.BTCUSDT",
        "orderbook.1.ETHUSDT"
    ]
}
```

<a id="понимание-фильтров-webSocket-отписка"></a>

### Понимание фильтров WebSocket: Отписка

Вы можете динамически подписываться и отписываться от топиков без отключения от WebSocket следующим образом:  

```json
{
    "req_id": "customised_id",  // необязательный
    "op": "unsubscribe",
    "args": [
        "publicTrade.BTCUSDT"
    ],
}
```

<a id="понимание-ответа-на-подписку"></a>

## Понимание ответа на подписку

Пример сообщения ответа на подписку на топик  

##### Private

```json
{
    "success": true,
    "ret_msg": "",
    "op": "subscribe",
    "conn_id": "cejreassvfrsfvb9v1a0-2m"
}
```

##### Public Spot

```json
{
    "success": true,
    "ret_msg": "subscribe",
    "conn_id": "2324d924-aa4d-45b0-a858-7b8be29ab52b",
    "req_id": "10001",
    "op": "subscribe"
}
```

##### Linear/Inverse

```json
{
    "success": true,
    "ret_msg": "",
    "conn_id": "3cd84cb1-4d06-4a05-930a-2efe5fc70f0f",
    "req_id": "",
    "op": "subscribe"
}
```

##### Option/Spread

```json
{
    "success": true,
    "conn_id": "aa01fbfffe80af37-00000001-000b37b9-7147f432704fd28c-00e1c172",
    "data": {
    "failTopics": [],
    "successTopics": [
        "orderbook.100.BTC-6JAN23-18000-C"
    ]
},
    "type": "COMMAND_RESP"
}
```
