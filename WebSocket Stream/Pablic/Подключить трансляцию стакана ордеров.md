- [Информация](#информация)
- [Поток данных](#поток-данных)
- [Подписка](#подписка)
- [Примеры подписки](#примеры-подписки)
- [Пример ответа при удачной подписки](#пример-ответа-при-удачной-подписки)
- [Пример получаемых данных](#пример-получаемых-данных)
- [Параметры получаемых данных](#параметры-получаемых-данных)
<a id="информация"></a>

Подписка на стакан ордеров.

***Глубины и частота обновлений***

- `linear`, `inverse`
  - Глубина 1, частота обновлений: 10 мс
  - Глубина 50, частота обновлений: 20 мс
  - Глубина 200, частота обновлений: 100 мс
  - Глубина 1000, частота обновлений: 200 мс

- `spot`
  - Глубина 1, частота обновлений: 10 мс
  - Глубина 50, частота обновлений: 20 мс
  - Глубина 200, частота обновлений: 200 мс
  - Глубина 1000, частота обновлений: 200 мс

- `option`
  - Глубина 25, частота обновлений: 20 мс
  - Глубина 100, частота обновлений: 100 мс

***Обработка снимка/дельты***

Чтобы обрабатывать сообщения `snapshot` и `delta`, следуйте этим правилам:  
После успешной подписки вы получите `snapshot`. WebSocket будет продолжать отправлять сообщения `delta` каждый раз,
когда стакан заявок изменяется. Если вы получите новое сообщение `snapshot`, вам придется сбросить локальный стакан
заявок. В случае проблемы на стороне Bybit, `snapshot` будет повторно отправлен, что гарантирует наличие самых
свежих данных.

Чтобы применить обновления `delta`

- Если вы получаете объем, равный `0`, удалите запись
- Если вы получаете объем, который не существует, вставьте его
- Если запись существует, просто обновите значение

Смотреть рабочие примеры кода этой логики в разделе [FAQ](https://bybit-exchange.github.io/docs/faq#how-can-i-process-websocket-snapshot-and-delta-messages).

>Информация:
>
>- Заявки [Retail Price Improvement (RPI)](https://www.bybit.com/en/help-center/article/Retail-Price-Improvement-RPI-Order)
> не будут включены в сообщения.
>- Для данных уровня 1 `linear`, `inverse` и `spot`: если прошло 3 секунды без изменения в стакане заявок, сообщение
> `snapshot` будет отправлено повторно, и поле `u` будет таким же, как в предыдущем сообщении.
>- Данные уровня 1 `linear`, `inverse` и `spot` имеют только сообщение `snapshot`

<a id="поток-данных"></a>

## Поток данных

`orderbook.{depth}.{symbol}`

<a id="подписка"></a>

## Подписка

```json
{
    "op": "subscribe",
    "args": [
        "orderbook.1.BTCUSDT"
    ]
}
```

<a id="примеры-подписки"></a>

## Примеры подписки

- собственная реализация

  ```python
  import json
  import time
  import websocket
  
  URL = "wss://stream-testnet.bybit.com/v5/public/linear"
  
  def on_message(ws, message):
      print(f"Полученное сообщение: {message}")
  
  def on_error(ws, error):
      print(f"Ошибка: {error}")
  
  def on_close(ws, close_status_code, close_msg):
      print(f"Соединение закрыто: {close_status_code} {close_msg}")
  
  def on_open(ws):
      print("Соединение открыто")
      request = {
          "op": "subscribe",
          "args": [
              "orderbook.50.BTCUSDT"
          ]
      }
      ws.send(json.dumps(request))
  
  def run_websocket():
      while True:
          ws = websocket.WebSocketApp(URL)
          ws.on_message = on_message
          ws.on_error = on_error
          ws.on_close = on_close
          ws.on_open = on_open
  
          ws.run_forever(
              ping_interval=20,
              ping_timeout=5
          )
  
          print("Соединение потеряно. Попытка переподключения...")
          time.sleep(5)
  
  run_websocket()
  ```

- pybit

  ```python
  from time import sleep

  from pybit.unified_trading import WebSocket

  ws = WebSocket(
      testnet=True,
      channel_type="linear",
  )

  def handle_message(message):
      print(message)

  ws.orderbook_stream(
      depth=50,
      symbol="BTCUSDT",
      callback=handle_message
  )

  while True:
      sleep(1)
  ```

<a id="пример-ответа-при-удачной-подписки"></a>

## Пример ответа при удачной подписки

```json
{
    "req_id": "",
    "success": true,
    "ret_msg": "",
    "op": "subscribe",
    "conn_id": "d427n9atbetr53r4s1eg-d2mt",
}
```

<a id="пример-получаемых-данных"></a>

## Пример получаемых данных

```json
{
    "topic": "orderbook.50.BTCUSDT",
    "type": "delta",  // при первой отправке ответа `snapshot`
    "ts": 1687940967466,
    "data": {
        "s": "BTCUSDT",
        "b": [
            [
                "30247.20",
                "30.028"
            ],
            [
                "30245.40",
                "0.224"
            ],
        ],
        "a": [
            [
                "30248.70",
                "0"
            ],
            [
                "30249.30",
                "0.892"
            ],
        ],
        "u": 177400507,
        "seq": 66544703342
    },
    "cts": 1687940967464
}
```

<a id="параметры-получаемых-данных"></a>

## Параметры получаемых данных

|Параметр  |Тип       |Комментарии                                             |
|----------|----------|--------------------------------------------------------|
|topic     |string    |Название потока данных                                             |
|type      |string    |Тип данных. `snapshot`, `delta`                                             |
|ts        |number    |Метка времени (в миллисекундах), когда система генерирует данные                                             |
|data      |map       |Массив объектов                                             |
|s         |string    |Название символа                                             |
|b         |array     |Цена покупки.<br>Для `snapshot`.<br>Сортировка по убыванию цены.                                             |
|b[0]      |string    |Цена предложения                |
|b[1]      |string    |Количество предложения<br>Если в `delta` size=0, что означает, что все предложения по этой цене были исполнены или отменены.    |
|a         |array     |Цена продажи.<br>Для `snapshot`.<br>Сортировка по возрастанию цены.                                             |
|a[0]      |string    |Цена предложения                                             |
|a[1]      |string    |Количество предложения<br>Если в `delta` size=0, что означает, что все предложения по этой цене были исполнены или отменены     |
|u         |integer   |Идентификатор обновления.<br>Время от времени вы можете получить `u`=1, что является снимком данных из-за перезапуска сервиса. Поэтому, пожалуйста, перезапишите ваш локальный стакан заявок<br>Для уровня 1 `linear` и `inverse` снимок данных будет отправлен повторно, если нет изменений в течение 3 секунд, и `u` будет таким же, как в предыдущем сообщении.                                          |
|seq       |string    |Кросс-последовательность<br>Вы можете использовать это поле для сравнения данных стакана заявок разных уровней, и если значение seq меньше, это означает, что данные были сгенерированы раньше                                             |
|cts       |number    |Временная метка, полученная от системы сопоставления данных, когда были получены данные этой книги ордеров. Её можно сопоставить с `T` из [Подключить трансляцию последних сделок по символу](<../Pablic/Подключить трансляцию последних сделок по символу.md>).                                           |
